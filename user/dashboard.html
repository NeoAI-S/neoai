<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>NEO AI 프로세서 - 대시보드</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ✅ 파비콘: 루트에 favicon.png 두면 가장 안전 -->
  <link rel="icon" type="image/png" href="/favicon.png" />

  <style>
    * { box-sizing: border-box; }

    @font-face {
      font-family: 'SUIT-Regular';
      src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_suit@1.0/SUIT-Regular.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    body {
      margin: 0;
      font-family: 'SUIT-Regular', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      color: #0f172a;
      background:
        radial-gradient(circle at 0% 0%, rgba(129, 140, 248, 0.25), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(52, 211, 153, 0.2), transparent 55%),
        linear-gradient(135deg, #eef2ff, #fefce8);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 18px 12px 28px;
    }

    .shell { width: 100%; max-width: 1000px; }

    .frame {
      border-radius: 26px;
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(226, 232, 240, 0.9);
      box-shadow:
        0 20px 60px rgba(148, 163, 184, 0.45),
        0 0 0 1px rgba(255, 255, 255, 0.8);
      padding: 18px 20px 22px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .logo {
      font-weight: 800;
      font-size: 19px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #111827;
      user-select: none;
    }
    .logo span {
      color: #4f46e5;
      font-weight: 900;
      letter-spacing: 0.24em;
    }

    .nav {
      display: flex;
      gap: 8px;
      font-size: 14px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .nav button {
      padding: 7px 15px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: #f3f4f6;
      color: #111827;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.16s ease;
    }
    .nav button.active {
      background: #111827;
      color: #f9fafb;
      box-shadow: 0 10px 28px rgba(15, 23, 42, 0.35);
      transform: translateY(-1px);
    }
    .nav button:hover:not(.active) { background: #e5e7eb; }

    .card {
      border-radius: 20px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 16px 40px rgba(148, 163, 184, 0.25);
      padding: 18px;
      margin-bottom: 14px;
      position: relative;
      overflow: hidden;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 6px;
      color: #111827;
    }

    .section-sub {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 14px;
    }

    .value-row {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      margin-top: 6px;
    }
    .value-box {
      flex: 1;
      min-width: 180px;
      padding: 14px;
      border-radius: 16px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      position: relative;
      overflow: hidden;
    }
    .value-label {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .value-main {
      font-size: 22px;
      font-weight: 800;
      color: #111827;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      line-height: 1.1;
      white-space: nowrap;
    }

    .amount-positive {
      color: #059669;
      font-weight: 900;
      text-shadow: 0 0 4px rgba(16, 185, 129, 0.25);
    }
    .amount-muted { color: #4b5563; }

    .pulse-up { animation: pulseUp 700ms ease-out 1; }
    .pulse-down { animation: pulseDown 700ms ease-out 1; }
    @keyframes pulseUp {
      0%   { filter: drop-shadow(0 0 0 rgba(239,68,68,0.0)); transform: translateY(0); }
      30%  { filter: drop-shadow(0 0 14px rgba(239,68,68,0.35)); transform: translateY(-1px); }
      100% { filter: drop-shadow(0 0 0 rgba(239,68,68,0.0)); transform: translateY(0); }
    }
    @keyframes pulseDown {
      0%   { filter: drop-shadow(0 0 0 rgba(59,130,246,0.0)); transform: translateY(0); }
      30%  { filter: drop-shadow(0 0 14px rgba(59,130,246,0.35)); transform: translateY(-1px); }
      100% { filter: drop-shadow(0 0 0 rgba(59,130,246,0.0)); transform: translateY(0); }
    }

    .cardGlowUp { animation: cardGlowUp 700ms ease-out 1; }
    .cardGlowDown { animation: cardGlowDown 700ms ease-out 1; }
    @keyframes cardGlowUp {
      0%{ box-shadow: 0 16px 40px rgba(148,163,184,0.25); }
      40%{ box-shadow: 0 18px 55px rgba(239,68,68,0.25); }
      100%{ box-shadow: 0 16px 40px rgba(148,163,184,0.25); }
    }
    @keyframes cardGlowDown {
      0%{ box-shadow: 0 16px 40px rgba(148,163,184,0.25); }
      40%{ box-shadow: 0 18px 55px rgba(59,130,246,0.25); }
      100%{ box-shadow: 0 16px 40px rgba(148,163,184,0.25); }
    }

    .sweep-up::after,
    .sweep-down::after{
      content:"";
      position:absolute;
      inset:0;
      transform: translateX(-120%);
      animation: sweep 700ms ease 1;
      pointer-events:none;
    }
    .sweep-up::after{
      background: linear-gradient(90deg, transparent, rgba(239,68,68,.22), transparent);
    }
    .sweep-down::after{
      background: linear-gradient(90deg, transparent, rgba(59,130,246,.22), transparent);
    }
    @keyframes sweep { to { transform: translateX(120%); } }

    .skeleton::after{
      content:'';
      position:absolute;
      inset:0;
      background: linear-gradient(90deg,
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,0.55) 50%,
        rgba(255,255,255,0) 100%);
      transform: translateX(-100%);
      animation: shimmer 1.1s infinite;
      pointer-events:none;
    }
    @keyframes shimmer{
      0%{ transform: translateX(-100%); }
      100%{ transform: translateX(100%); }
    }

    .delta-badge{
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      font-weight: 800;
      border: 1px solid transparent;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transform: translateY(-1px);
    }
    .delta-up{ background:#fee2e2; color:#dc2626; border-color:#fecaca; }
    .delta-down{ background:#dbeafe; color:#2563eb; border-color:#bfdbfe; }
    .delta-same{ background:#e5e7eb; color:#6b7280; border-color:#d1d5db; }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 11px;
      border-radius: 999px;
      font-size: 12px;
      gap: 6px;
    }
    .status-dot { width: 7px; height: 7px; border-radius: 999px; }
    .status-wait { background: #fef3c7; color: #92400e; border: 1px solid #facc15; }
    .status-wait .status-dot { background: #facc15; }
    .status-run { background: #dcfce7; color: #166534; border: 1px solid #22c55e; }
    .status-run .status-dot { background: #22c55e; }
    .status-done { background: #e5e7eb; color: #374151; border: 1px solid #9ca3af; }
    .status-done .status-dot { background: #6b7280; }

    .info-text {
      font-size: 13px;
      color: #6b7280;
      margin-top: 10px;
      line-height: 1.6;
    }

    .steps-row { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    .step {
      flex:1; min-width:160px;
      padding:10px 11px;
      border-radius:14px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-size:12px;
      color:#4b5563;
      position:relative;
    }
    .step-title { font-size:13px; font-weight:600; margin-bottom:4px; color:#111827; }
    .step-tag {
      position:absolute; top:8px; right:10px;
      font-size:10px; padding:2px 7px; border-radius:999px;
      background:#fff; border:1px solid #e5e7eb; color:#6b7280;
    }
    .step.active {
      border-color:#4f46e5;
      box-shadow: 0 0 0 1px rgba(79,70,229,0.25);
      background:#eef2ff;
    }
    .step.active .step-tag { background:#4f46e5; border-color:#4f46e5; color:#e5e7eb; }

    .intro-grid { display:grid; grid-template-columns: minmax(0,1.2fr) minmax(0,1fr); gap:18px; }
    @media (max-width: 720px){ .intro-grid{ grid-template-columns: 1fr; } }

    .intro-badge { display:inline-flex; padding:4px 11px; border-radius:999px; font-size:11px; background:#eef2ff; color:#4f46e5; margin-bottom:10px; }
    .intro-title { font-size:18px; font-weight:700; margin-bottom:8px; color:#111827; }
    .intro-text { font-size:14px; color:#4b5563; line-height:1.7; white-space:pre-line; margin:0; }

    .intro-box { padding:12px; border-radius:16px; background:#f9fafb; border:1px solid #e5e7eb; margin-top:10px; }
    .intro-box-title { font-size:14px; font-weight:600; margin-bottom:6px; color:#111827; }
    .intro-points { font-size:13px; color:#374151; list-style:none; padding:0; margin:0; }
    .intro-points li { margin-bottom:6px; }
    .scenario-highlight { font-weight:600; color:#4f46e5; }

    .account-grid { display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:10px; font-size:13px; }
    @media (max-width: 720px){ .account-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    .acct-label { font-size:12px; color:#6b7280; margin-bottom:2px; }
    .acct-value { font-size:14px; font-weight:500; color:#111827; }

    .account-header-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:10px; flex-wrap:wrap; }
    .btn-gear {
      border:none; background:#f3f4f6; border-radius:999px;
      padding:5px 10px; font-size:12px; cursor:pointer;
      color:#4b5563;
    }
    .btn-gear:hover { background:#e5e7eb; }

    .card-head-row{
      display:flex;
      justify-content: space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .mini-actions{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .last-updated{ font-size: 12px; color:#6b7280; }
    .btn-refresh{
      border:none; background:#f3f4f6; color:#111827;
      border-radius:999px; padding:6px 10px; font-size:12px; cursor:pointer;
    }
    .btn-refresh:hover{ background:#e5e7eb; }

    .toggle{
      display:inline-flex;
      background:#f3f4f6;
      border:1px solid #e5e7eb;
      border-radius:999px;
      padding:3px;
      gap:3px;
    }
    .toggle button{
      border:none; background:transparent;
      padding:6px 10px; border-radius:999px;
      font-size:12px; cursor:pointer; color:#374151; font-weight:800;
    }
    .toggle button.active{
      background:#111827;
      color:#fff;
      box-shadow: 0 8px 18px rgba(15,23,42,0.18);
    }

    .chart-wrap{
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
    }
    .chart-title-row{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap:10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .chart-title{ font-size: 13px; font-weight: 900; color:#111827; }
    canvas{ width:100%; height:120px; display:block; }

    .error-inline{
      margin-top:10px;
      font-size:12px;
      color:#b91c1c;
      display:none;
    }
    .error-inline.show{ display:block; }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }
    .modal {
      width: 100%;
      max-width: 360px;
      background: #ffffff;
      border-radius: 18px;
      padding: 18px 18px 16px;
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.45);
      border: 1px solid #e5e7eb;
    }
    .modal-title { font-size: 16px; font-weight: 800; margin-bottom: 10px; }
    .modal label { display: block; font-size: 13px; margin-top: 10px; margin-bottom: 4px; color: #374151; }
    .modal input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 13px;
    }
    .modal input:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.4);
      background: #ffffff;
    }
    .modal-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:14px; }
    .btn-secondary, .btn-primary {
      border-radius: 999px;
      border: none;
      font-size: 13px;
      padding: 7px 14px;
      cursor: pointer;
    }
    .btn-secondary { background: #f3f4f6; color: #374151; }
    .btn-primary {
      background: linear-gradient(135deg, #6366f1, #0ea5e9);
      color: #f9fafb;
      font-weight: 800;
    }

    .hidden { display: none; }
  </style>
</head>

<body>
  <div class="shell">
    <div class="frame">
      <header class="topbar">
        <div class="logo"><span>NEO AI</span> PROCESSOR</div>
        <nav class="nav">
          <button id="tabStatus" class="active" type="button">AI 투자현황</button>
          <button id="tabIntro" type="button">소개</button>
          <button id="tabAccount" type="button">내 정보</button>
          <button id="btnLogout" type="button">로그아웃</button>
        </nav>
      </header>

      <section id="sectionStatus" class="card">
        <div class="section-title">AI 투자현황</div>
        <div class="section-sub" id="nameLine"></div>

        <div class="value-row">
          <div class="value-box" id="boxTopAmount">
            <div class="value-label">AI투자중인 금액</div>
            <div class="value-main" id="amountText">- 원</div>
          </div>
          <div class="value-box" id="boxTopStatus">
            <div class="value-label">진행 상태</div>
            <div id="statusBadge"></div>
          </div>
        </div>
      </section>

      <section id="sectionRealtime" class="card">
        <div class="card-head-row">
          <div>
            <div class="section-title" style="margin-bottom:0;">실시간 수익 현황</div>
            <div class="section-sub" style="margin-bottom:0;">네오 AI 투자 프로세서 기준, 현재 세션의 실시간 금액 정보입니다.</div>
          </div>

          <div class="mini-actions">
            <div class="toggle" aria-label="수익 토글">
              <button id="toggleToday" class="active" type="button">오늘 수익</button>
              <button id="toggleTotal" type="button">누적 수익</button>
            </div>
            <span class="last-updated" id="lastUpdatedText">마지막 업데이트: -</span>
            <button class="btn-refresh" id="btnRefresh" type="button">재조회</button>
          </div>
        </div>

        <div class="value-row">
          <div class="value-box" id="boxInvest">
            <div class="value-label">투자중인 금액</div>
            <div class="value-main amount-muted" id="amountInvestText">- 원</div>
          </div>
          <div class="value-box" id="boxRealized">
            <div class="value-label" id="realizedLabel">수익 (오늘)</div>
            <div class="value-main amount-muted" id="realizedAmountText">- 원</div>
          </div>
          <div class="value-box" id="boxTotal">
            <div class="value-label">총 금액 (투자중 + 실현)</div>
            <div class="value-main amount-muted" id="totalAmountText">- 원</div>
          </div>
        </div>

        <div class="chart-wrap">
          <div class="chart-title-row">
            <div class="chart-title" id="chartTitle">실시간 수익 그래프 (오늘)</div>
            <span class="last-updated" id="chartHint">최근 데이터 기준</span>
          </div>
          <canvas id="profitChart" width="920" height="160"></canvas>
        </div>

        <div class="info-text">투자중인 금액과 실현된 수익을 합산한 금액이 총 금액으로 표시됩니다.</div>

        <div class="error-inline" id="realtimeError">
          조회 실패: 네트워크/권한/테이블 컬럼을 확인해주세요.
          <button class="btn-refresh" id="btnRetryInline" type="button">다시 시도</button>
        </div>
      </section>

      <section id="sectionStatusExtra" class="card">
        <div class="section-title">AI 세션 진행 단계</div>
        <div class="section-sub">네오AI는 아래 3단계를 거쳐 세션을 운용합니다.</div>

        <div class="steps-row">
          <div class="step" data-step="wait">
            <div class="step-title">1단계 · 대기중</div>
            <div class="step-tag">READY</div>
            <div>투자금 확정 전 단계입니다.<br/>투자가 확정되면 다음 단계로 이동합니다.</div>
          </div>
          <div class="step" data-step="run">
            <div class="step-title">2단계 · 진행중</div>
            <div class="step-tag">RUNNING</div>
            <div>설정된 금액에 맞춰 AI가 분산 투자를 수행하는 구간입니다.<br/>포트폴리오 구성과 비중 조정이 자동으로 이뤄집니다.</div>
          </div>
          <div class="step" data-step="done">
            <div class="step-title">3단계 · 진행 완료</div>
            <div class="step-tag">COMPLETE</div>
            <div>투자 운용이 완료된 상태입니다.<br/>수익 정산을 준비합니다.</div>
          </div>
        </div>
      </section>

      <section id="sectionIntro" class="card hidden">
        <div class="intro-badge">AI 기반 자동 투자 프로세스</div>
        <div class="intro-grid">
          <div>
            <div class="intro-title">네오AI, 스스로 판단하고 분산 투자하는 인공지능</div>
            <p class="intro-text">
네오AI는 대량의 시장 데이터와 딥러닝 알고리즘을 활용해
시장 흐름을 분석하고, 여러 종목과 자산군에 자동으로 분산 투자하는
AI 투자 프로세서입니다.

사용자는 투자 금액만 정하면,
AI가 포트폴리오 구성부터 리스크 관리까지 전 과정을 자동으로 수행하도록 설계되어 있습니다.
            </p>

            <div class="intro-box">
              <div class="intro-box-title">AI가 하는 일</div>
              <ul class="intro-points">
                <li>· 경제 지표, 뉴스, 시황 데이터를 종합적으로 스캔</li>
                <li>· 최대 30개 내외 종목으로 포트폴리오 자동 구성</li>
                <li>· 최소 1일 ~ 최대 30일 단위로 세션 운용</li>
                <li>· 손익·변동성 데이터를 기반으로 전략을 반복 학습</li>
              </ul>
            </div>
          </div>

          <div>
            <div class="intro-box">
              <div class="intro-box-title">투자 예시 시나리오 (전문 운영 관점)</div>
              <p class="intro-text" style="margin-top:4px;">
<span class="scenario-highlight">예시 · 50,000원을 AI에 맡기는 경우</span>

1) 세션 설정 → 진행중 전환
2) 시장/종목 스캔
3) 포트폴리오 구성
4) 리스크 관리
5) 세션 종료 및 정산

유저는 투자 금액과 운용 여부만 확인하고,
실제 종목 선택·비중 조정·리스크 관리는 모두 네오AI가 담당합니다.
              </p>
            </div>

            <div class="intro-box" style="margin-top:10px;">
              <div class="intro-box-title">이런 분께 적합합니다</div>
              <ul class="intro-points">
                <li>· 세부 종목 선택보다는 전체 전략·결과에 집중하고 싶은 분</li>
                <li>· 단기 구간별(1일 ~ 최대 30일) 운용을 선호하는 분</li>
                <li>· AI 기반 의사결정과 분산 투자를 한 번에 경험해 보고 싶은 분</li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <section id="sectionAccount" class="card hidden">
        <div class="account-header-row">
          <div>
            <div class="section-title">내 정보</div>
            <div class="section-sub">네오 AI 투자 프로세서에서 사용하는 기본 회원 정보입니다.</div>
          </div>
          <button class="btn-gear" id="btnOpenSettings" type="button">⚙ 설정</button>
        </div>

        <div class="account-grid">
          <div><div class="acct-label">이름</div><div class="acct-value" id="acctName">-</div></div>
          <div><div class="acct-label">아이디</div><div class="acct-value" id="acctUsername">-</div></div>
          <div><div class="acct-label">휴대폰</div><div class="acct-value" id="acctPhone">-</div></div>
          <div><div class="acct-label">투자중인 금액</div><div class="acct-value" id="acctAmount">-</div></div>
          <div><div class="acct-label">수익 실현중인 금액</div><div class="acct-value" id="acctRealized">-</div></div>
          <div><div class="acct-label">출금 계좌</div><div class="acct-value" id="acctBank">-</div></div>
        </div>

        <div class="info-text" style="margin-top:12px;">
          출금 계좌는 본인 확인 및 출금 처리 시에만 사용되며, 관리자 페이지에서만 조회·관리됩니다.
        </div>
      </section>

      <div id="settingsModal" class="modal-backdrop hidden">
        <div class="modal">
          <div class="modal-title">내 정보 수정</div>
          <p class="section-sub" style="margin-bottom:4px;">비밀번호와 출금 계좌 정보를 변경할 수 있습니다.</p>

          <label for="editPassword">새 비밀번호</label>
          <input type="password" id="editPassword" placeholder="변경하지 않으려면 비워두세요" />

          <label for="editBank">출금 계좌</label>
          <input type="text" id="editBank" placeholder="예: 국민 123456-01-123456" />

          <div class="modal-actions">
            <button class="btn-secondary" id="btnCancelSettings" type="button">취소</button>
            <button class="btn-primary" id="btnSaveSettings" type="button">저장하기</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== 설정값 ======
    var supabaseUrl = 'https://uvwturgomovjvokojtkp.supabase.co';
    var supabaseKey = 'sb_publishable_a6k4T2_-ksuHVUvCduUlCQ_DtoR9R4F';
    var supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    var currentUser = null;

    // 이전값
    var prevAmount = 0;
    var prevRealizedToday = 0;
    var prevRealizedTotal = 0;
    var prevTotal = 0;
    var hasPrev = false;

    // today | total
    var profitMode = 'today';
    var lastUpdatedAt = null;

    var chartState = { points: [], maxPoints: 40 };

    // ====== 유틸 ======
    function qs(id){ return document.getElementById(id); }

    function formatAmount(value){
      if (value == null || isNaN(value)) return '- 원';
      return Number(value).toLocaleString('ko-KR') + ' 원';
    }

    function maskPhone(phone){
      if (!phone) return '-';
      var digits = String(phone).replace(/[^0-9]/g, '');
      if (digits.length < 8) return phone;
      var head = digits.slice(0,3);
      var tail = digits.slice(-4);
      return head + '-****-' + tail;
    }

    function relativeTime(fromDate){
      if (!fromDate) return '-';
      var now = Date.now();
      var diff = Math.max(0, now - fromDate.getTime());
      var sec = Math.floor(diff / 1000);
      if (sec < 10) return '방금';
      if (sec < 60) return sec + '초 전';
      var min = Math.floor(sec / 60);
      if (min < 60) return min + '분 전';
      var hr = Math.floor(min / 60);
      if (hr < 24) return hr + '시간 전';
      var day = Math.floor(hr / 24);
      return day + '일 전';
    }

    function updateLastUpdatedLabel(){
      var el = qs('lastUpdatedText');
      el.textContent = '마지막 업데이트: ' + (lastUpdatedAt ? relativeTime(lastUpdatedAt) : '-');
    }

    function setSkeleton(on){
      var boxes = [qs('boxTopAmount'), qs('boxInvest'), qs('boxRealized'), qs('boxTotal')];
      boxes.forEach(function(b){
        if (!b) return;
        if (on) b.classList.add('skeleton');
        else b.classList.remove('skeleton');
      });
    }

    function setRealtimeError(show, msg){
      var box = qs('realtimeError');
      if (!show){
        box.classList.remove('show');
        return;
      }
      if (msg) {
        box.firstChild.nodeValue = msg + ' ';
      }
      box.classList.add('show');
    }

    // ====== UI 렌더 ======
    function renderStatus(status){
      var badge = qs('statusBadge');
      badge.innerHTML = '';

      var wrapper = document.createElement('span');
      wrapper.classList.add('status-pill');

      var dot = document.createElement('span');
      dot.classList.add('status-dot');

      var text = document.createElement('span');

      if (!status || status === '대기중'){
        wrapper.classList.add('status-wait');
        text.textContent = '대기중';
      } else if (status === '진행중'){
        wrapper.classList.add('status-run');
        text.textContent = '진행중';
      } else {
        wrapper.classList.add('status-done');
        text.textContent = '진행 완료';
      }

      wrapper.appendChild(dot);
      wrapper.appendChild(text);
      badge.appendChild(wrapper);
    }

    function renderSteps(status){
      var steps = document.querySelectorAll('.step');
      steps.forEach(function(step){ step.classList.remove('active'); });

      var key = 'wait';
      if (status === '진행중') key = 'run';
      else if (status === '진행 완료') key = 'done';

      var target = document.querySelector('.step[data-step="' + key + '"]');
      if (target) target.classList.add('active');
    }

    function fillAccountInfo(userFromDb){
      var merged = Object.assign({}, currentUser || {}, userFromDb || {});
      qs('acctName').textContent = merged.name || '-';
      qs('acctUsername').textContent = merged.username || '-';
      qs('acctPhone').textContent = merged.phone ? maskPhone(merged.phone) : '-';
      qs('acctAmount').textContent = formatAmount(merged.amount || 0);
      qs('acctRealized').textContent = formatAmount(merged.realized_amount || 0);
      qs('acctBank').textContent = merged.bank_account || '-';
    }

    function animateMoney(el, from, to, durationMs){
      if (!Number.isFinite(from)) from = 0;
      if (!Number.isFinite(to)) to = 0;
      durationMs = durationMs || 650;

      if (from === to){
        el.textContent = formatAmount(to);
        return;
      }

      var start = performance.now();
      var diff = to - from;

      function tick(now){
        var t = Math.min(1, (now - start) / durationMs);
        var eased = 1 - Math.pow(1 - t, 3);
        var val = Math.round(from + diff * eased);
        el.textContent = formatAmount(val);
        if (t < 1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    function buildDeltaBadge(delta){
      var badge = document.createElement('span');
      badge.className = 'delta-badge';

      if (delta > 0){
        badge.classList.add('delta-up');
        badge.textContent = '▲ ' + formatAmount(delta);
      } else if (delta < 0){
        badge.classList.add('delta-down');
        badge.textContent = '▼ ' + formatAmount(Math.abs(delta));
      } else {
        badge.classList.add('delta-same');
        badge.textContent = '– 0원';
      }
      return badge;
    }

    function setValueWithBadge(el, value, prevValue){
      var delta = value - prevValue;
      el.innerHTML = '';
      var textNode = document.createElement('span');
      textNode.textContent = formatAmount(value);
      el.appendChild(textNode);
      el.appendChild(buildDeltaBadge(delta));
    }

    function applyPulse(el, direction){
      el.classList.remove('pulse-up','pulse-down');
      void el.offsetWidth;
      if (direction === 'up') el.classList.add('pulse-up');
      if (direction === 'down') el.classList.add('pulse-down');
    }

    function applyCardGlow(cardEl, direction){
      cardEl.classList.remove('cardGlowUp','cardGlowDown');
      void cardEl.offsetWidth;
      if (direction === 'up') cardEl.classList.add('cardGlowUp');
      if (direction === 'down') cardEl.classList.add('cardGlowDown');
    }

    function applySweep(cardEl, direction){
      cardEl.classList.remove('sweep-up','sweep-down');
      void cardEl.offsetWidth;
      if (direction === 'up') cardEl.classList.add('sweep-up');
      if (direction === 'down') cardEl.classList.add('sweep-down');
    }

    // ====== 차트 ======
    function pushChartPoint(v){
      chartState.points.push(v);
      if (chartState.points.length > chartState.maxPoints) chartState.points.shift();
    }

    function drawChart(){
      var canvas = qs('profitChart');
      var ctx = canvas.getContext('2d');
      var w = canvas.width, h = canvas.height;

      ctx.clearRect(0,0,w,h);

      // grid
      ctx.lineWidth = 1;
      ctx.strokeStyle = 'rgba(148,163,184,0.35)';
      for (var i=1;i<=3;i++){
        var y = (h/4)*i;
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
      }

      var pts = chartState.points;
      if (pts.length < 2) return;

      var min = Math.min.apply(null, pts);
      var max = Math.max.apply(null, pts);
      var range = Math.max(1, max - min);

      var padX = 10, padY = 12;

      ctx.lineWidth = 2.2;
      ctx.strokeStyle = 'rgba(79,70,229,0.9)';
      ctx.beginPath();

      pts.forEach(function(v, idx){
        var x = padX + ((w - padX*2) * (idx / (pts.length - 1)));
        var y = (h - padY) - ((h - padY*2) * ((v - min) / range));
        if (idx === 0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.stroke();

      // last dot
      var last = pts[pts.length - 1];
      var lx = padX + (w - padX*2);
      var ly = (h - padY) - ((h - padY*2) * ((last - min) / range));
      ctx.fillStyle = 'rgba(79,70,229,1)';
      ctx.beginPath(); ctx.arc(lx, ly, 4, 0, Math.PI*2); ctx.fill();
    }

    // ====== 데이터 ======
    async function fetchTodayProfitFromLogs(userId){
      // profit_logs 테이블이 없어도 동작해야 하므로 try/catch + null 반환
      try {
        var start = new Date();
        start.setHours(0,0,0,0);

        var res = await supabase
          .from('profit_logs')
          .select('amount_delta, created_at')
          .eq('user_id', userId)
          .gte('created_at', start.toISOString());

        if (res.error) return null;
        if (!Array.isArray(res.data)) return null;

        return res.data.reduce(function(sum, r){
          return sum + Number(r.amount_delta || 0);
        }, 0);
      } catch (e) {
        return null;
      }
    }

    function setModeUI(){
      var todayBtn = qs('toggleToday');
      var totalBtn = qs('toggleTotal');
      var label = qs('realizedLabel');
      var title = qs('chartTitle');

      if (profitMode === 'today'){
        todayBtn.classList.add('active');
        totalBtn.classList.remove('active');
        label.textContent = '수익 (오늘)';
        title.textContent = '실시간 수익 그래프 (오늘)';
      } else {
        totalBtn.classList.add('active');
        todayBtn.classList.remove('active');
        label.textContent = '수익 (누적)';
        title.textContent = '실시간 수익 그래프 (누적)';
      }
    }

    async function loadStatus(){
      var nameLine = qs('nameLine');
      var amountText = qs('amountText');
      var investEl = qs('amountInvestText');
      var realizedEl = qs('realizedAmountText');
      var totalEl = qs('totalAmountText');

      var boxRealized = qs('boxRealized');
      var boxTotal = qs('boxTotal');

      var displayName = (currentUser && (currentUser.name || currentUser.username)) ? (currentUser.name || currentUser.username) : '';
      nameLine.textContent = displayName ? (displayName + '님의 AI 투자 진행 정보입니다.') : 'AI 투자 진행 정보입니다.';

      setRealtimeError(false);
      setSkeleton(true);

      try {
        var result = await supabase
          .from('users')
          .select('*')
          .eq('username', currentUser.username)
          .maybeSingle();

        if (result.error){
          console.error(result.error);
          setSkeleton(false);
          setRealtimeError(true, '조회 실패: Supabase 오류가 발생했습니다.');
          return;
        }

        var data = result.data;

        if (!data){
          setSkeleton(false);
          amountText.textContent = '- 원';
          investEl.textContent = '- 원';
          realizedEl.textContent = '- 원';
          totalEl.textContent = '- 원';
          renderStatus('대기중');
          renderSteps('대기중');
          fillAccountInfo({});
          lastUpdatedAt = null;
          updateLastUpdatedLabel();
          return;
        }

        var amount = Number(data.amount || 0);
        var realizedTotal = Number(data.realized_amount || 0);

        var realizedToday = 0;
        var maybeToday = await fetchTodayProfitFromLogs(data.id);
        if (typeof maybeToday === 'number') realizedToday = maybeToday;

        var realizedShown = (profitMode === 'today') ? realizedToday : realizedTotal;
        var total = amount + realizedTotal;

        amountText.textContent = formatAmount(amount);

        // 색상
        investEl.classList.remove('amount-positive');
        investEl.classList.add('amount-muted');

        realizedEl.classList.remove('amount-muted','amount-positive');
        totalEl.classList.remove('amount-muted','amount-positive');

        realizedEl.classList.add(realizedShown > 0 ? 'amount-positive' : 'amount-muted');
        totalEl.classList.add(total > 0 ? 'amount-positive' : 'amount-muted');

        if (!hasPrev){
          investEl.textContent = formatAmount(amount);
          realizedEl.textContent = formatAmount(realizedShown);
          totalEl.textContent = formatAmount(total);

          chartState.points = [];
          for (var i=0;i<8;i++) pushChartPoint(realizedShown);
          drawChart();

          hasPrev = true;
        } else {
          // 카운트업은 먼저
          animateMoney(investEl, prevAmount, amount, 650);

          var prevShown = (profitMode === 'today') ? prevRealizedToday : prevRealizedTotal;
          animateMoney(realizedEl, prevShown, realizedShown, 650);
          animateMoney(totalEl, prevTotal, total, 650);

          // 배지
          setValueWithBadge(investEl, amount, prevAmount);
          setValueWithBadge(realizedEl, realizedShown, prevShown);
          setValueWithBadge(totalEl, total, prevTotal);

          // 방향
          var dirReal = (realizedShown > prevShown) ? 'up' : ((realizedShown < prevShown) ? 'down' : null);
          var dirTot = (total > prevTotal) ? 'up' : ((total < prevTotal) ? 'down' : null);

          if (dirReal){
            applyPulse(realizedEl, dirReal);
            applyCardGlow(boxRealized, dirReal);
          }
          if (dirTot){
            applyPulse(totalEl, dirTot);
            applyCardGlow(boxTotal, dirTot);
            applySweep(boxTotal, dirTot);
          }

          pushChartPoint(realizedShown);
          drawChart();
        }

        // prev 저장
        prevAmount = amount;
        prevTotal = total;
        prevRealizedTotal = realizedTotal;
        prevRealizedToday = realizedToday;

        renderStatus(data.status);
        renderSteps(data.status);
        fillAccountInfo(data);

        setSkeleton(false);

        lastUpdatedAt = new Date();
        updateLastUpdatedLabel();
      } catch (e){
        console.error(e);
        setSkeleton(false);
        setRealtimeError(true, '조회 실패: 네트워크/스크립트 오류가 발생했습니다.');
      }
    }

    function requireLogin(){
      var raw = localStorage.getItem('neoai_current_user');
      if (!raw){
        alert('로그인이 필요합니다.');
        window.location.href = 'index.html';
        return;
      }
      try{
        currentUser = JSON.parse(raw);
      } catch (e){
        localStorage.removeItem('neoai_current_user');
        window.location.href = 'index.html';
      }
    }

    function showTab(which){
      var tabStatus = qs('tabStatus');
      var tabIntro = qs('tabIntro');
      var tabAccount = qs('tabAccount');

      var sectionStatus = qs('sectionStatus');
      var sectionRealtime = qs('sectionRealtime');
      var sectionStatusExtra = qs('sectionStatusExtra');
      var sectionIntro = qs('sectionIntro');
      var sectionAccount = qs('sectionAccount');

      tabStatus.classList.remove('active');
      tabIntro.classList.remove('active');
      tabAccount.classList.remove('active');

      sectionStatus.classList.add('hidden');
      sectionRealtime.classList.add('hidden');
      sectionStatusExtra.classList.add('hidden');
      sectionIntro.classList.add('hidden');
      sectionAccount.classList.add('hidden');

      if (which === 'status'){
        tabStatus.classList.add('active');
        sectionStatus.classList.remove('hidden');
        sectionRealtime.classList.remove('hidden');
        sectionStatusExtra.classList.remove('hidden');
      } else if (which === 'intro'){
        tabIntro.classList.add('active');
        sectionIntro.classList.remove('hidden');
      } else {
        tabAccount.classList.add('active');
        sectionAccount.classList.remove('hidden');
      }
    }

    // ====== 이벤트 바인딩(여기서부터 “클릭/탭/로그아웃”이 살아남) ======
    window.addEventListener('DOMContentLoaded', function(){
      // 기본 이벤트
      qs('tabStatus').addEventListener('click', function(){ showTab('status'); });
      qs('tabIntro').addEventListener('click', function(){ showTab('intro'); });
      qs('tabAccount').addEventListener('click', function(){ showTab('account'); });

      qs('btnLogout').addEventListener('click', function(){
        localStorage.removeItem('neoai_current_user');
        alert('로그아웃 되었습니다.');
        window.location.href = 'index.html';
      });

      qs('btnRefresh').addEventListener('click', loadStatus);
      qs('btnRetryInline').addEventListener('click', loadStatus);

      qs('toggleToday').addEventListener('click', function(){
        profitMode = 'today';
        setModeUI();
        chartState.points = [];
        hasPrev = false;
        loadStatus();
      });

      qs('toggleTotal').addEventListener('click', function(){
        profitMode = 'total';
        setModeUI();
        chartState.points = [];
        hasPrev = false;
        loadStatus();
      });

      // 설정 모달
      var settingsModal = qs('settingsModal');

      qs('btnOpenSettings').addEventListener('click', function(){
        settingsModal.classList.remove('hidden');
        qs('editPassword').value = '';
        qs('editBank').value = (currentUser && currentUser.bank_account) ? currentUser.bank_account : '';
      });

      qs('btnCancelSettings').addEventListener('click', function(){
        settingsModal.classList.add('hidden');
      });

      qs('btnSaveSettings').addEventListener('click', async function(){
        var newPw = qs('editPassword').value.trim();
        var newBank = qs('editBank').value.trim();

        if (!currentUser || !currentUser.id){
          alert('사용자 정보를 확인할 수 없습니다.');
          return;
        }

        var payload = {};
        if (newPw) payload.password = newPw;
        payload.bank_account = newBank || null;

        var res = await supabase
          .from('users')
          .update(payload)
          .eq('id', currentUser.id)
          .select('*')
          .maybeSingle();

        if (res.error){
          console.error(res.error);
          alert('정보 수정 중 오류가 발생했습니다.');
          return;
        }

        currentUser = Object.assign({}, currentUser, res.data);
        localStorage.setItem('neoai_current_user', JSON.stringify(currentUser));
        fillAccountInfo(res.data);
        settingsModal.classList.add('hidden');
        alert('정보가 저장되었습니다.');
      });

      // 상대 시간 갱신
      setInterval(function(){
        if (lastUpdatedAt) updateLastUpdatedLabel();
      }, 5000);

      // 초기 실행
      requireLogin();
      setModeUI();
      showTab('status');
      loadStatus();
    });
  </script>
</body>
</html>
